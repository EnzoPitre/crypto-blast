<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Blast | Simulateur Crypto Temps R√©el</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e5e7eb; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .apexcharts-series path { filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.5)); transition: filter 0.3s ease; }
        .chart-down .apexcharts-series path { filter: drop-shadow(0 0 4px rgba(244, 63, 94, 0.5)); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        @keyframes slide-in-top { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-news-item { animation: slide-in-top 0.5s ease-out; }
        .modal-overlay { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    </style>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { gray: { 950: '#030712' } }, animation: { 'spin-slow': 'spin 3s linear infinite', } } }
        }
    </script>
</head>
<body class="flex flex-col h-screen overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- WELCOME MODAL -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
        <div class="bg-gray-900 border border-blue-500/30 rounded-2xl max-w-lg w-full p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-emerald-500"></div>
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center border border-blue-500/50 shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                    <i data-lucide="brain-circuit" class="w-8 h-8 text-blue-400"></i>
                </div>
            </div>
            <h2 class="text-2xl font-black text-white text-center mb-2 italic tracking-tight">Bienvenue sur CRYPTO<span class="text-blue-500">BLAST</span></h2>
            <p class="text-center text-gray-400 text-sm mb-8">Votre simulateur de trading personnel.</p>
            <div class="space-y-4 mb-8">
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-emerald-900/30 rounded text-emerald-400 mt-1"><i data-lucide="wifi" class="w-4 h-4"></i></div>
                    <div><h3 class="text-white font-bold text-sm">Donn√©es Hybrides</h3><p class="text-xs text-gray-400">Cours r√©els Binance + Sc√©narios fictifs.</p></div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-rose-900/30 rounded text-rose-400 mt-1"><i data-lucide="save" class="w-4 h-4"></i></div>
                    <div><h3 class="text-white font-bold text-sm">Sauvegarde Auto</h3><p class="text-xs text-gray-400">Votre progression est enregistr√©e automatiquement.</p></div>
                </div>
            </div>
            <button onclick="closeWelcome()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-lg transition-all active:scale-95 shadow-lg shadow-blue-900/20">C'EST PARTI !</button>
        </div>
    </div>

    <!-- SELL CONFIRMATION MODAL -->
    <div id="sell-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-gray-900 border border-rose-500/30 rounded-2xl max-w-sm w-full p-6 shadow-2xl relative overflow-hidden animate-fade-in">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 to-orange-500"></div>
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5 text-rose-500"></i> Vendre position</h3>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-950 rounded border border-gray-800">
                    <span class="text-gray-400 text-sm">Actif</span>
                    <span id="sell-modal-asset" class="font-bold text-white text-lg">BTC</span>
                </div>

                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Quantit√© √† vendre</span>
                        <span class="cursor-pointer hover:text-white" onclick="setMaxSellModal()">Dispo: <span id="sell-modal-max-qty">0.00</span></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="sell-modal-input-qty" class="w-full bg-gray-950 border border-gray-700 rounded p-3 text-white font-mono text-lg focus:border-rose-500 focus:outline-none transition-colors" placeholder="0.00">
                        <button onclick="setMaxSellModal()" class="bg-gray-800 hover:bg-gray-700 text-xs px-3 rounded text-gray-300 font-bold border border-gray-700 transition-colors">MAX</button>
                    </div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-500">Cours actuel</span>
                    <span id="sell-modal-price" class="font-mono text-gray-300">...</span>
                </div>

                <div class="h-px bg-gray-800"></div>

                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Total estim√©</span>
                    <span id="sell-modal-total" class="font-bold text-xl text-emerald-400">0.00 $</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="closeSellModal()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition-colors">ANNULER</button>
                <button id="confirm-sell-btn" class="w-full bg-rose-600 hover:bg-rose-500 text-white font-bold py-3 rounded-lg transition-colors shadow-[0_0_15px_rgba(225,29,72,0.4)]">
                    VALIDER
                </button>
            </div>
        </div>
    </div>

    <!-- FLASH NEWS MODAL -->
    <div id="flash-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
        <div id="flash-content" class="border-2 rounded-2xl max-w-lg w-full p-6 shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden bg-gray-900"></div>
    </div>

    <!-- HEADER -->
    <header class="h-16 border-b border-gray-800 bg-gray-950 flex items-center justify-between px-4 lg:px-6 shrink-0 z-20 shadow-lg shadow-black/50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded relative overflow-hidden group hidden sm:block">
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                <i data-lucide="activity" class="w-5 h-5 text-white relative z-10"></i>
            </div>
            <div>
                <h1 class="text-lg lg:text-xl font-black text-white tracking-tighter italic">
                    CRYPTO<span class="text-blue-500">BLAST</span>
                </h1>
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest" id="connection-status">
                    <span class="flex items-center gap-1 text-rose-500"><i data-lucide="wifi-off" class="w-3 h-3"></i> Connecting...</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 lg:gap-8">
            <button onclick="resetApp()" class="text-gray-500 hover:text-white transition-colors p-2" title="R√©initialiser"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
            <button id="refill-btn" onclick="refillBalance()" class="hidden flex items-center gap-2 bg-rose-600 hover:bg-rose-500 text-white px-3 py-1.5 rounded font-bold text-[10px] lg:text-xs uppercase tracking-wider animate-pulse shadow-[0_0_15px_rgba(225,29,72,0.6)] transition-all">
                <i data-lucide="refresh-cw" class="w-3 h-3 animate-spin-slow"></i> <span class="hidden sm:inline">Renflouer</span>
            </button>

            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Liquidit√©s</span>
                <span id="balance-display" class="font-mono font-bold text-base lg:text-lg text-white">$10,000.00</span>
            </div>
            <div class="hidden sm:block h-8 w-px bg-gray-800"></div>
            <div class="hidden sm:flex flex-col items-end mr-2">
                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Valeur Totale</span>
                <div id="networth-display" class="flex items-center gap-2 font-mono font-bold text-lg text-emerald-400">$10,000.00</div>
            </div>
            <div class="flex bg-gray-900 rounded border border-gray-800 p-0.5">
                <button onclick="setCurrency('USD')" id="btn-usd" class="px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow">USD</button>
                <button onclick="setCurrency('EUR')" id="btn-eur" class="px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300">EUR</button>
            </div>
        </div>
    </header>

    <!-- CONTENT -->
    <div class="flex flex-1 overflow-hidden flex-col lg:flex-row">
        <!-- LEFT SIDEBAR -->
        <aside class="hidden lg:flex w-72 bg-gray-950 border-r border-gray-800 flex-col shrink-0">
            <div class="p-4 border-b border-gray-800">
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-500 w-4 h-4 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="search-input" placeholder="Filtrer (ex: SUI)..." class="w-full bg-gray-900 border border-gray-800 rounded pl-9 pr-4 py-2 text-sm text-white focus:outline-none focus:border-blue-600 transition-all placeholder-gray-600">
                </div>
            </div>
            <div class="overflow-y-auto flex-1 custom-scrollbar" id="asset-list"></div>
        </aside>

        <!-- CENTER -->
        <main class="flex-1 flex flex-col min-w-0 bg-gray-950/50 relative">
            <div class="lg:hidden p-2 border-b border-gray-800 bg-gray-900">
                <select id="mobile-asset-select" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-700 font-bold" onchange="selectAsset(this.value)"></select>
            </div>
            <div class="h-16 border-b border-gray-800 flex items-center justify-between px-4 lg:px-6 bg-black/40 backdrop-blur-sm">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded bg-gradient-to-tr from-gray-800 to-gray-700 flex items-center justify-center border border-gray-600 text-white font-black text-lg shadow-lg" id="asset-icon">B</div>
                    <div>
                        <h2 class="text-lg lg:text-2xl font-black text-white leading-none tracking-tight flex items-center gap-2"><span id="asset-name">Bitcoin</span> <span class="text-gray-600 text-sm lg:text-lg font-medium">/ <span id="current-currency">USD</span></span></h2>
                        <div class="flex items-center gap-3 mt-0.5"><span class="text-[10px] text-blue-400 bg-blue-900/20 px-1.5 rounded border border-blue-900/50">VOLATILIT√â: HAUTE</span></div>
                    </div>
                </div>
                <div class="text-right"><div id="asset-price" class="text-xl lg:text-3xl font-mono font-bold tracking-tighter text-white">...</div></div>
            </div>
            <div class="flex-1 p-2 lg:p-4 relative bg-black/20 h-1/2 lg:h-auto min-h-[300px]">
                <div class="w-full h-full rounded-xl border border-gray-800 bg-black/60 overflow-hidden relative group shadow-2xl" id="chart-container"></div>
                <div class="absolute top-4 left-4 z-10 pointer-events-none">
                    <div class="flex items-center gap-2 bg-black/80 backdrop-blur px-3 py-1.5 rounded border border-gray-700 text-xs text-gray-300 shadow"><span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span> LIVE SOCKET</div>
                </div>
            </div>
            <div class="h-auto lg:h-80 border-t border-gray-800 bg-gray-900 flex flex-col lg:flex-row">
                <div class="w-full lg:w-96 p-4 lg:p-6 border-r border-gray-800 flex flex-col bg-gray-950 shadow-[inset_-10px_0_20px_-10px_rgba(0,0,0,0.5)]">
                    <div class="flex items-center justify-between mb-4"><h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> Action Rapide</h3><div class="text-[10px] text-gray-500 border border-gray-700 px-1.5 py-0.5 rounded cursor-help">Ordre March√©</div></div>
                    <div class="space-y-3">
                        <div class="bg-gray-900 p-3 rounded border border-gray-800 focus-within:border-blue-500 transition-all group">
                            <div class="flex justify-between text-xs text-gray-500 mb-1"><span class="group-focus-within:text-blue-400 transition-colors">Je d√©pense (<span class="currency-label">USD</span>)</span><span onclick="setMaxBuy()" class="text-gray-600 hover:text-white cursor-pointer transition-colors text-[10px] uppercase font-bold">MAX</span></div>
                            <input type="number" id="input-fiat" class="w-full bg-transparent text-white font-mono text-lg focus:outline-none placeholder-gray-800 font-bold" placeholder="0.00">
                        </div>
                        <div class="flex justify-center -my-4 z-10 relative"><div class="bg-gray-800 rounded-full p-1.5 border border-gray-700 text-gray-400 shadow-xl"><i data-lucide="arrow-right-left" class="w-3 h-3"></i></div></div>
                        <div class="bg-gray-900 p-3 rounded border border-gray-800 focus-within:border-blue-500 transition-all group">
                            <div class="flex justify-between text-xs text-gray-500 mb-1"><span class="group-focus-within:text-blue-400 transition-colors">Volume (<span id="symbol-label">BTC</span>)</span><span onclick="setMaxSell()" class="text-gray-600 hover:text-white cursor-pointer transition-colors text-[10px] uppercase font-bold">VENDRE MAX</span></div>
                            <input type="number" id="input-qty" class="w-full bg-transparent text-white font-mono text-lg focus:outline-none placeholder-gray-800 font-bold" placeholder="0.000000">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4 pt-2">
                        <button onclick="executeTrade('BUY')" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 lg:py-4 rounded font-black text-sm transition-all active:scale-95 shadow-[0_4px_0_rgb(6,95,70)] active:shadow-none active:translate-y-[4px] uppercase tracking-widest">ACHETER</button>
                        <button onclick="executeTrade('SELL')" class="bg-rose-600 hover:bg-rose-500 text-white py-3 lg:py-4 rounded font-black text-sm transition-all active:scale-95 shadow-[0_4px_0_rgb(159,18,57)] active:shadow-none active:translate-y-[4px] uppercase tracking-widest">VENDRE</button>
                    </div>
                    <div id="notification-area" class="mt-3 h-8"></div>
                </div>
                <div class="flex-1 flex flex-col bg-gray-900 min-h-[200px]">
                    <div class="flex items-center justify-between border-b border-gray-800 bg-gray-950 px-4 py-3"><h3 class="text-xs font-bold uppercase tracking-wider text-blue-400">Vos Positions Actives</h3><div class="text-[10px] text-gray-500">P&L en temps r√©el</div></div>
                    <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="bg-gray-900 text-gray-500 text-[10px] uppercase sticky top-0 z-10 border-b border-gray-800"><tr><th class="px-4 py-3 font-medium">Actif</th><th class="px-4 py-3 font-medium text-right">Qt√© / Prix Moy.</th><th class="px-4 py-3 font-medium text-right">PnL (Gain/Perte)</th><th class="px-4 py-3 font-medium text-right">Actions</th></tr></thead>
                            <tbody class="divide-y divide-gray-800/30" id="portfolio-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="hidden lg:flex w-80 bg-gray-950 border-l border-gray-800 flex-col shrink-0">
            <div class="p-5 border-b border-gray-800 bg-gradient-to-b from-blue-900/20 to-transparent">
                <h3 class="text-blue-400 text-xs font-black uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="lightbulb" class="w-4 h-4"></i> Strat√©gie & Conseils</h3>
                <div class="bg-gray-900 border border-blue-900/30 p-4 rounded-xl relative overflow-hidden shadow-lg">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="rocket" class="w-12 h-12"></i></div>
                    <h4 class="text-white font-bold text-sm mb-2" id="tip-title">...</h4>
                    <p class="text-xs text-gray-400 leading-relaxed min-h-[60px]" id="tip-text">...</p>
                    <div class="flex justify-center gap-1 mt-3" id="tip-dots"></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center">
                    <h3 class="text-gray-400 text-xs font-black uppercase tracking-widest flex items-center gap-2"><i data-lucide="newspaper" class="w-4 h-4"></i> Market News</h3>
                    <span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30 animate-pulse">LIVE</span>
                </div>
                <div class="flex-1 overflow-y-auto p-0 custom-scrollbar relative" id="news-feed"></div>
            </div>
        </aside>
    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
        const BINANCE_MAP = {
            'BTC':'btcusdt','ETH':'ethusdt','SOL':'solusdt','BNB':'bnbusdt','XRP':'xrpusdt','ADA':'adausdt','DOGE':'dogeusdt','DOT':'dotusdt','AVAX':'avaxusdt','LINK':'linkusdt','MATIC':'maticusdt','LTC':'ltcusdt',
            'UNI':'uniusdt','ATOM':'atomusdt','ETC':'etcusdt','FIL':'filusdt','NEAR':'nearusdt','APT':'aptusdt','ARB':'arbusdt','OP':'opusdt','INJ':'injusdt','RNDR':'rndrusdt','PEPE':'pepeusdt','SHIB':'shibusdt',
            'TRX':'trxusdt','XLM':'xlmusdt','BCH':'bchusdt','ALGO':'algousdt','VET':'vetusdt','ICP':'icpusdt','SAND':'sandusdt','MANA':'manausdt','AXS':'axsusdt','EGLD':'egldusdt','THETA':'thetausdt','FTM':'ftmusdt',
            'SUI':'suiusdt','SEI':'seiusdt','TIA':'tiausdt','STX':'stxusdt','IMX':'imxusdt','RUNE':'runeusdt','FET':'fetusdt','AGIX':'agixusdt','FLOKI':'flokiusdt','BONK':'bonkusdt','WIF':'wifusdt','JUP':'jupusdt'
        };
        
        // --- GLOBAL STATE ---
        let state = { currency: 'USD', balance: 10000, portfolio: {}, history: [], selectedAssetId: 'BTC', marketBias: 1.0, newsFeed: [], tipIndex: 0 };
        let assets = Object.keys(BINANCE_MAP).map(k => ({ id: k, name: k, symbol: k, basePrice: 100, currentPrice: 100, change24h: 0, priceHistory: Array(50).fill(0).map((_,i)=>({time:i,price:100})) }));
        let chartInstance = null, ws = null, biasTimeout = null, currentSellAssetId = null;

        // EVENTS & NEWS
        const SCENARIOS = [
            { title: "ALERTE: SEC Approuve ETF", desc: "Les institutions entrent.", advice: "ACHAT FORT.", impact: 1.05, duration: 20000, type: 'success' },
            { title: "URGENT: Hack Exchange", desc: "Panique march√©.", advice: "VENTE CONSEILL√âE.", impact: 0.92, duration: 15000, type: 'error' },
            { title: "Elon Musk Tweet", desc: "Volatilit√© extr√™me.", advice: "Risqu√©.", impact: 1.08, duration: 10000, type: 'success' }
        ];
        const NEWS = ["SEC reporte d√©cision ETF.", "UE finalise loi MiCA.", "Hong Kong ouvre crypto.", "Fear & Greed: Extreme Greed.", "BlackRock lance fonds tokenis√©.", "Visa teste paiements gas.", "Tether imprime 1Mds USDT.", "JPMorgan s'int√©resse √† la DeFi."];
        const TIPS = [
            {title:"DCA", text:"Investissez une somme fixe r√©guli√®rement."}, {title:"Stop-Loss", text:"D√©finissez votre perte max avant d'entrer."},
            {title:"DYOR", text:"Faites vos propres recherches."}, {title:"R√®gle 1%", text:"Ne risquez jamais plus de 1% par trade."}
        ];

        // --- EXPOSED FUNCTIONS ---
        function closeWelcome() { document.getElementById('welcome-modal').classList.add('hidden'); }
        function closeFlash() { document.getElementById('flash-modal').classList.add('hidden'); }
        function closeSellModal() { document.getElementById('sell-modal').classList.add('hidden'); }
        function resetApp() { if(confirm("Effacer tout l'historique ?")) { localStorage.removeItem('tradeLearnPro_gh'); location.reload(); } }
        
        function setCurrency(c) {
            state.currency = c;
            updateUI();
            document.getElementById('btn-usd').className = c === 'USD' ? "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow" : "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300";
            document.getElementById('btn-eur').className = c === 'EUR' ? "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow" : "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300";
        }

        function selectAsset(id, mode = 'BUY') {
            state.selectedAssetId = id;
            renderAssetsList(); updateChart();
            document.getElementById('input-fiat').value = ''; document.getElementById('input-qty').value = '';
            document.getElementById('mobile-asset-select').value = id;
            if(mode === 'SELL') setMaxSell();
        }

        function setMaxBuy() { handleFiatChange(state.balance.toString()); document.getElementById('input-fiat').value = state.balance.toFixed(2); }
        function setMaxSell() { const entry = state.portfolio[state.selectedAssetId]; const val = entry ? entry.qty : 0; handleQtyChange(val.toString()); document.getElementById('input-qty').value = val; }

        function initiateSell(assetId) {
            const entry = state.portfolio[assetId]; const asset = assets.find(a => a.id === assetId);
            if (!entry || !asset) return;
            currentSellAssetId = assetId;
            const price = getLastPrice(asset);
            document.getElementById('sell-modal-asset').innerText = asset.symbol;
            document.getElementById('sell-modal-max-qty').innerText = entry.qty.toFixed(6);
            document.getElementById('sell-modal-price').innerText = formatMoney(price, true);
            const input = document.getElementById('sell-modal-input-qty');
            input.value = '';
            document.getElementById('sell-modal-total').innerText = formatMoney(0);
            input.oninput = function() {
                const val = parseFloat(this.value) || 0;
                document.getElementById('sell-modal-total').innerText = formatMoney(val * getLastPrice(asset));
            };
            document.getElementById('confirm-sell-btn').onclick = function() { executeSellFromModal(); };
            document.getElementById('sell-modal').classList.remove('hidden');
        }

        function setMaxSellModal() {
            const entry = state.portfolio[currentSellAssetId];
            if(entry) { const input = document.getElementById('sell-modal-input-qty'); input.value = entry.qty; input.dispatchEvent(new Event('input')); }
        }

        function executeSellFromModal() {
            const qty = parseFloat(document.getElementById('sell-modal-input-qty').value);
            const entry = state.portfolio[currentSellAssetId];
            const asset = assets.find(a => a.id === currentSellAssetId);
            if (!entry || !asset || !qty || qty <= 0 || qty > entry.qty) return;
            
            const price = getLastPrice(asset); const total = qty * price;
            state.balance += total;
            const newQty = Math.max(0, entry.qty - qty);
            if (newQty === 0) delete state.portfolio[currentSellAssetId];
            else state.portfolio[currentSellAssetId] = { qty: newQty, avgPrice: entry.avgPrice };
            
            state.history.unshift({ date: new Date(), type: 'SELL', asset: asset.symbol, qty, price, total });
            renderPortfolio(); updateHeaderData(); closeSellModal();
            notify(`Vente ${qty} ${asset.symbol} r√©ussie`, 'success');
        }

        function executeTrade(type) {
            const asset = getSelectedAsset();
            const price = getLastPrice(asset);
            const qty = parseFloat(document.getElementById('input-qty').value);
            if (!qty || qty <= 0) return notify("Montant invalide", 'error');
            const total = qty * price;
            
            if (type === 'BUY') {
                if (total > state.balance) return notify("Fonds insuffisants", 'error');
                state.balance -= total;
                const current = state.portfolio[asset.id] || { qty: 0, avgPrice: 0 };
                const newQty = current.qty + qty;
                const newAvg = ((current.qty * current.avgPrice) + total) / newQty;
                state.portfolio[asset.id] = { qty: newQty, avgPrice: newAvg };
                notify(`Achat r√©ussi`, 'success');
            } else {
                const current = state.portfolio[asset.id];
                if (!current || qty > current.qty) return notify("Solde insuffisant", 'error');
                state.balance += total;
                const newQty = Math.max(0, current.qty - qty);
                if (newQty === 0) delete state.portfolio[asset.id];
                else state.portfolio[asset.id] = { qty: newQty, avgPrice: current.avgPrice };
                notify(`Vente r√©ussie`, 'success');
            }
            state.history.unshift({ date: new Date(), type, asset: asset.symbol, qty, price, total });
            renderPortfolio(); updateHeaderData();
            document.getElementById('input-qty').value = ''; document.getElementById('input-fiat').value = '';
        }

        function refillBalance() { state.balance += 10000; updateHeaderData(); notify("Compte renflou√© !", 'success'); }

        // --- HELPERS ---
        function getSelectedAsset() { return assets.find(a => a.id === state.selectedAssetId) || assets[0]; }
        function getLastPrice(asset) { return asset.currentPrice * state.marketBias; }
        function formatMoney(amount, isPrice) {
            const rate = state.currency === 'EUR' ? 0.92 : 1;
            const sym = state.currency === 'EUR' ? '‚Ç¨' : '$';
            const val = amount * rate;
            let dec = 2; if(isPrice) { if(val<1) dec=4; if(val<0.01) dec=6; if(val>1000) dec=2; }
            return `${sym}${val.toLocaleString('fr-FR', { minimumFractionDigits: dec, maximumFractionDigits: dec })}`;
        }
        function notify(msg, type) {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-emerald-900/50 text-emerald-200' : 'bg-rose-900/50 text-rose-200';
            area.innerHTML = `<div class="text-xs font-bold text-center py-2 rounded border border-white/10 ${color} animate-fade-in">${msg}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }
        function handleFiatChange(val) {
            const p = getLastPrice(getSelectedAsset()); document.getElementById('input-qty').value = val ? (parseFloat(val)/p).toFixed(6) : '';
        }
        function handleQtyChange(val) {
            const p = getLastPrice(getSelectedAsset()); document.getElementById('input-fiat').value = val ? (parseFloat(val)*p).toFixed(2) : '';
        }

        function updateHeaderData() {
            document.getElementById('balance-display').innerText = formatMoney(state.balance);
            let portfolioVal = 0;
            Object.entries(state.portfolio).forEach(([id, data]) => {
                const asset = assets.find(a => a.id === id);
                if (asset) portfolioVal += data.qty * getLastPrice(asset);
            });
            const netWorth = state.balance + portfolioVal;
            const pnl = netWorth - 10000;
            const nwEl = document.getElementById('networth-display');
            nwEl.innerText = formatMoney(netWorth);
            nwEl.className = `flex items-center gap-2 font-mono font-bold text-lg ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-500'}`;
            const refillBtn = document.getElementById('refill-btn');
            if (state.balance < 50) refillBtn.classList.remove('hidden'); else refillBtn.classList.add('hidden');
        }

        // --- INIT & LOOPS ---
        function init() {
            // Load & Migrate Data
            const saved = localStorage.getItem('tradeLearnPro_gh');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (isNaN(parsed.balance)) parsed.balance = 10000;
                    if (parsed.portfolio) {
                        const cleanPortfolio = {};
                        Object.entries(parsed.portfolio).forEach(([k, v]) => {
                            if (typeof v === 'number') cleanPortfolio[k] = { qty: v, avgPrice: 0 };
                            else if (v && typeof v.qty === 'number') cleanPortfolio[k] = v;
                        });
                        parsed.portfolio = cleanPortfolio;
                    }
                    state = { ...state, ...parsed };
                } catch(e) { console.error("Resetting state", e); }
            }

            if(typeof lucide !== 'undefined') lucide.createIcons();
            initChart(); renderAssetsList(); renderMobileSelect(); updateUI(); connectWS();
            
            // Loop Price Updates
            setInterval(() => {
                assets.forEach(a => {
                    const p = a.currentPrice * state.marketBias;
                    a.priceHistory.push({time: Date.now(), price: p});
                    if(a.priceHistory.length > 50) a.priceHistory.shift();
                    const start = a.priceHistory[0].price;
                    a.change24h = ((p - start) / start) * 100;
                });
                updateChart(); updateHeaderData(); updateAssetListUI(); renderPortfolio();
                localStorage.setItem('tradeLearnPro_gh', JSON.stringify({ balance: state.balance, portfolio: state.portfolio, history: state.history }));
            }, 1000);

            // News Loops
            setInterval(() => { 
                const news = NEWS[Math.floor(Math.random() * NEWS.length)];
                addNewsToFeed({ title: news, type: 'info', time: "√Ä L'INSTANT" });
            }, 15000);
            setInterval(() => { if (Math.random() < 0.025) triggerEvent(); }, 60000);
            if(state.newsFeed.length === 0) NEWS.slice(0,5).forEach(n => addNewsToFeed({ title: n, type: 'info', time: "Recents" }));
            else state.newsFeed.forEach(n => addNewsToFeed(n, false));
            
            renderTip();
            
            // Bindings
            document.getElementById('input-fiat').addEventListener('input', (e) => handleFiatChange(e.target.value));
            document.getElementById('input-qty').addEventListener('input', (e) => handleQtyChange(e.target.value));
            document.getElementById('search-input').addEventListener('input', (e) => filterAssets(e.target.value));
        }

        function connectWS() {
            const url = `wss://stream.binance.com:9443/stream?streams=${Object.values(BINANCE_MAP).map(s=>s+'@trade').join('/')}`;
            ws = new WebSocket(url);
            ws.onopen = () => { document.getElementById('connection-status').innerHTML = `<span class="text-emerald-400">‚óè LIVE</span>`; };
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if(d.data) {
                    const a = assets.find(x => BINANCE_MAP[x.id].toUpperCase() === d.data.s);
                    if(a) { a.currentPrice = parseFloat(d.data.p); if(a.basePrice===100) a.basePrice=a.currentPrice; }
                }
            };
        }

        function initChart() {
            if(typeof ApexCharts === 'undefined') return;
            const opts = { chart: { type: 'area', height: '100%', toolbar:{show:false}, animations:{enabled:false}, background:'transparent' }, theme:{mode:'dark'}, stroke:{curve:'smooth',width:2}, dataLabels:{enabled:false}, grid:{borderColor:'#333',strokeDashArray:3}, xaxis:{labels:{show:false},axisBorder:{show:false},axisTicks:{show:false}}, yaxis:{opposite:true,labels:{style:{colors:'#9ca3af'},formatter:(v)=>v.toFixed(2)}}, fill:{type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.05}}, colors:['#10b981'], series:[{data:[]}], tooltip:{theme:'dark'} };
            chartInstance = new ApexCharts(document.querySelector("#chart-container"), opts);
            chartInstance.render();
        }

        function updateChart() {
            if(!chartInstance) return;
            const a = getSelectedAsset();
            const d = a.priceHistory.map(p => p.price);
            const isUp = a.change24h >= 0;
            const color = isUp ? '#10b981' : '#f43f5e';
            document.querySelector("#chart-container").classList.toggle('chart-down', !isUp);
            chartInstance.updateOptions({ colors: [color], yaxis: { labels: { formatter: (v) => formatMoney(v, true).replace('$','').replace('‚Ç¨','') } } });
            chartInstance.updateSeries([{ data: d }]);
            document.getElementById('asset-name').innerText = a.name;
            document.getElementById('asset-icon').innerText = a.symbol[0];
            document.getElementById('current-currency').innerText = state.currency;
            document.getElementById('symbol-label').innerText = a.symbol;
            document.getElementById('asset-price').innerText = formatMoney(getLastPrice(a), true);
            document.getElementById('asset-price').className = `text-xl lg:text-3xl font-mono font-bold tracking-tighter ${isUp?'text-emerald-400':'text-rose-500'}`;
        }

        function renderAssetsList() {
            const el = document.getElementById('asset-list'); el.innerHTML = '';
            assets.forEach(a => {
                const div = document.createElement('div');
                div.className = `group px-4 py-3 border-b border-gray-800/50 cursor-pointer hover:bg-gray-900 relative overflow-hidden asset-item ${a.id===state.selectedAssetId ? 'bg-blue-900/10' : ''}`;
                div.dataset.id = a.id;
                div.onclick = () => selectAsset(a.id);
                div.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-bold text-sm text-gray-300 group-hover:text-white">${a.symbol}</span><span class="font-mono text-sm text-gray-200 price-display">...</span></div><div class="flex justify-between items-center"><span class="text-[10px] text-gray-500 uppercase truncate max-w-[100px]">${a.name}</span><span class="flex items-center gap-1 text-[10px] font-bold change-display">...</span></div>`;
                el.appendChild(div);
            });
        }

        function updateAssetListUI() {
            document.querySelectorAll('.asset-item').forEach(d => {
                const a = assets.find(x => x.id === d.dataset.id);
                if(a) {
                    const p = getLastPrice(a);
                    d.querySelector('.price-display').innerText = formatMoney(p, true);
                    const c = d.querySelector('.change-display');
                    c.innerText = `${a.change24h>=0?'+':''}${a.change24h.toFixed(2)}%`;
                    c.className = `flex items-center gap-1 text-[10px] font-bold change-display ${a.change24h>=0?'text-emerald-400':'text-rose-500'}`;
                }
            });
        }

        function renderPortfolio() {
            const el = document.getElementById('portfolio-body'); el.innerHTML = '';
            if(Object.keys(state.portfolio).length === 0) { el.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-600 text-xs">Portefeuille Vide</td></tr>`; return; }
            Object.entries(state.portfolio).forEach(([id, d]) => {
                const a = assets.find(x => x.id === id); if(!a) return;
                const p = getLastPrice(a); const val = d.qty * p; const cost = d.qty * d.avgPrice; const pnl = val - cost; const pp = cost>0 ? (pnl/cost)*100 : 0; const profit = pnl>=0;
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-800/30 hover:bg-gray-800/20";
                tr.innerHTML = `<td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-gray-800 flex items-center justify-center text-[10px] text-white border border-gray-700">${a.symbol[0]}</div><div><div class="font-bold text-white text-xs">${a.symbol}</div><div class="text-[9px] text-gray-500">${formatMoney(p, true)}</div></div></div></td><td class="px-4 py-3 text-right"><div class="text-gray-300 text-xs font-mono">${d.qty.toFixed(4)}</div><div class="text-[9px] text-gray-500">Moy: ${formatMoney(d.avgPrice, true)}</div></td><td class="px-4 py-3 text-right"><div class="text-xs font-bold ${profit?'text-emerald-400':'text-rose-500'}">${profit?'+':''}${formatMoney(pnl)}</div><div class="text-[9px] ${profit?'text-emerald-500/70':'text-rose-500/70'}">${profit?'+':''}${pp.toFixed(2)}%</div></td><td class="px-4 py-3 text-right"><button onclick="initiateSell('${id}')" class="px-2 py-1 rounded bg-rose-900/30 hover:bg-rose-600 text-rose-200 hover:text-white border border-rose-800 text-[10px] font-bold transition-all">VENDRE</button></td>`;
                el.appendChild(tr);
            });
        }

        function addNewsToFeed(n, anim=true) {
            const c = document.getElementById('news-feed');
            const d = document.createElement('div');
            d.className = `p-3 border-b border-gray-800 hover:bg-gray-900/50 transition-colors ${anim?'animate-news-item':''}`;
            d.innerHTML = `<div class="flex justify-between mb-1"><span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-400">${n.type}</span><span class="text-[9px] text-gray-600">${n.time}</span></div><p class="text-[11px] text-gray-300 leading-snug">${n.title}</p>`;
            c.insertBefore(d, c.firstChild);
            if(c.children.length > 20) c.removeChild(c.lastChild);
        }

        function triggerEvent() {
            const s = SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)];
            const m = document.getElementById('flash-modal');
            document.getElementById('flash-content').innerHTML = `<div class="text-center relative z-10"><h2 class="text-2xl font-black text-white mb-2 uppercase">FLASH MARCH√â</h2><h3 class="text-lg font-bold mb-4 text-blue-300">${s.title}</h3><p class="text-gray-300 text-sm mb-4">${s.desc}</p><button onclick="closeFlash()" class="w-full bg-white text-black font-bold py-3 rounded text-xs uppercase">OK</button></div>`;
            m.classList.remove('hidden');
            
            // Market Bias Effect
            const target = s.impact;
            let step = 0;
            const i = setInterval(() => { state.marketBias += (target - state.marketBias)*0.1; step++; if(step>20) clearInterval(i); }, 100);
            setTimeout(() => { const r = setInterval(() => { state.marketBias += (1.0 - state.marketBias)*0.05; if(Math.abs(state.marketBias-1)<0.001) { state.marketBias=1.0; clearInterval(r); } }, 200); }, s.duration);
        }

        function renderTip() {
            const t = TIPS[state.tipIndex];
            document.getElementById('tip-title').innerText = t.title;
            document.getElementById('tip-text').innerText = t.text;
            const d = document.getElementById('tip-dots'); d.innerHTML = '';
            TIPS.forEach((_,i) => { const el=document.createElement('div'); el.className=`h-1 rounded-full transition-all duration-300 ${i===state.tipIndex?'w-6 bg-blue-500':'w-2 bg-gray-700'}`; d.appendChild(el); });
        }

        function filterAssets(t) {
            const term = t.toLowerCase();
            document.querySelectorAll('.asset-item').forEach(el => {
                const id = el.dataset.id;
                const a = assets.find(x => x.id === id);
                el.style.display = (a && (a.name.toLowerCase().includes(term) || a.symbol.toLowerCase().includes(term))) ? 'block' : 'none';
            });
        }

        function renderMobileSelect() {
            const s = document.getElementById('mobile-asset-select'); s.innerHTML = '';
            assets.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.text = a.name; s.appendChild(o); });
            s.value = state.selectedAssetId;
        }

        function updateUI() {
            document.querySelectorAll('.currency-label').forEach(el => el.innerText = state.currency);
            updateHeaderData(); updateChart(); renderPortfolio();
        }

        window.onload = init;
    </script>
</body>
</html>
