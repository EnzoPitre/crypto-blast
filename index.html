<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Blast | Simulateur Crypto Temps R√©el</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e5e7eb; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Neon Chart Effect */
        .apexcharts-series path {
            filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.5)); /* Default green glow */
            transition: filter 0.3s ease;
        }
        .chart-down .apexcharts-series path {
            filter: drop-shadow(0 0 4px rgba(244, 63, 94, 0.5)); /* Red glow */
        }

        /* Animations */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        
        @keyframes slide-in-top { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-news-item { animation: slide-in-top 0.5s ease-out; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: { 950: '#030712' }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="flex flex-col h-screen overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- WELCOME MODAL -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
        <div class="bg-gray-900 border border-blue-500/30 rounded-2xl max-w-lg w-full p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-emerald-500"></div>
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center border border-blue-500/50 shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                    <i data-lucide="brain-circuit" class="w-8 h-8 text-blue-400"></i>
                </div>
            </div>
            <h2 class="text-2xl font-black text-white text-center mb-2 italic tracking-tight">Bienvenue sur CRYPTO<span class="text-blue-500">BLAST</span></h2>
            <p class="text-center text-gray-400 text-sm mb-8">Simulation de trading avec √©v√©nements de march√©.</p>
            <div class="space-y-4 mb-8">
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-emerald-900/30 rounded text-emerald-400 mt-1"><i data-lucide="wifi" class="w-4 h-4"></i></div>
                    <div><h3 class="text-white font-bold text-sm">Donn√©es Hybrides</h3><p class="text-xs text-gray-400">Cours r√©els Binance + Sc√©narios fictifs.</p></div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-rose-900/30 rounded text-rose-400 mt-1"><i data-lucide="alert-triangle" class="w-4 h-4"></i></div>
                    <div><h3 class="text-white font-bold text-sm">Gestion de Crise</h3><p class="text-xs text-gray-400">Des news impr√©vues vont impacter vos gains.</p></div>
                </div>
            </div>
            <button onclick="window.closeWelcome()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-lg transition-all active:scale-95 shadow-lg shadow-blue-900/20">C'EST PARTI !</button>
        </div>
    </div>

    <!-- FLASH NEWS MODAL -->
    <div id="flash-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
        <div id="flash-content" class="border-2 rounded-2xl max-w-lg w-full p-6 shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden bg-gray-900">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- SELL CONFIRMATION MODAL (UPDATED) -->
    <div id="sell-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-gray-900 border border-rose-500/30 rounded-2xl max-w-sm w-full p-6 shadow-2xl relative overflow-hidden animate-fade-in">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 to-orange-500"></div>
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5 text-rose-500"></i> Vendre position</h3>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-950 rounded border border-gray-800">
                    <span class="text-gray-400 text-sm">Actif</span>
                    <span id="sell-modal-asset" class="font-bold text-white text-lg">BTC</span>
                </div>

                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Quantit√© √† vendre</span>
                        <span class="cursor-pointer hover:text-white" onclick="window.setMaxSellModal()">Dispo: <span id="sell-modal-max-qty">0.00</span></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="sell-modal-input-qty" class="w-full bg-gray-950 border border-gray-700 rounded p-3 text-white font-mono text-lg focus:border-rose-500 focus:outline-none transition-colors" placeholder="0.00">
                        <button onclick="window.setMaxSellModal()" class="bg-gray-800 hover:bg-gray-700 text-xs px-3 rounded text-gray-300 font-bold border border-gray-700 transition-colors">MAX</button>
                    </div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-500">Cours actuel</span>
                    <span id="sell-modal-price" class="font-mono text-gray-300">...</span>
                </div>

                <div class="h-px bg-gray-800"></div>

                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Total estim√©</span>
                    <span id="sell-modal-total" class="font-bold text-xl text-emerald-400">0.00 $</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="window.closeSellModal()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition-colors">ANNULER</button>
                <button id="confirm-sell-btn" class="w-full bg-rose-600 hover:bg-rose-500 text-white font-bold py-3 rounded-lg transition-colors shadow-[0_0_15px_rgba(225,29,72,0.4)]">
                    VALIDER
                </button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-16 border-b border-gray-800 bg-gray-950 flex items-center justify-between px-4 lg:px-6 shrink-0 z-20 shadow-lg shadow-black/50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded relative overflow-hidden group hidden sm:block">
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                <i data-lucide="activity" class="w-5 h-5 text-white relative z-10"></i>
            </div>
            <div>
                <h1 class="text-lg lg:text-xl font-black text-white tracking-tighter italic">
                    CRYPTO<span class="text-blue-500">BLAST</span>
                </h1>
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest" id="connection-status">
                    <span class="flex items-center gap-1 text-rose-500"><i data-lucide="wifi-off" class="w-3 h-3"></i> Connecting...</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 lg:gap-8">
            <button id="refill-btn" onclick="window.refillBalance()" class="hidden flex items-center gap-2 bg-rose-600 hover:bg-rose-500 text-white px-3 py-1.5 rounded font-bold text-[10px] lg:text-xs uppercase tracking-wider animate-pulse shadow-[0_0_15px_rgba(225,29,72,0.6)] transition-all">
                <i data-lucide="refresh-cw" class="w-3 h-3 animate-spin-slow"></i> <span class="hidden sm:inline">Renflouer</span>
            </button>

            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Liquidit√©s (Cash)</span>
                <span id="balance-display" class="font-mono font-bold text-base lg:text-lg text-white">$10,000.00</span>
            </div>
            
            <div class="hidden sm:block h-8 w-px bg-gray-800"></div>
            
            <div class="hidden sm:flex flex-col items-end mr-2">
                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Valeur Totale</span>
                <div id="networth-display" class="flex items-center gap-2 font-mono font-bold text-lg text-emerald-400">$10,000.00</div>
            </div>

            <div class="flex bg-gray-900 rounded border border-gray-800 p-0.5">
                <button onclick="window.setCurrency('USD')" id="btn-usd" class="px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow">USD</button>
                <button onclick="window.setCurrency('EUR')" id="btn-eur" class="px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300">EUR</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="flex flex-1 overflow-hidden flex-col lg:flex-row">
        
        <!-- LEFT SIDEBAR -->
        <aside class="hidden lg:flex w-72 bg-gray-950 border-r border-gray-800 flex-col shrink-0">
            <div class="p-4 border-b border-gray-800">
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-500 w-4 h-4 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="search-input" placeholder="Filtrer (ex: SUI)..." class="w-full bg-gray-900 border border-gray-800 rounded pl-9 pr-4 py-2 text-sm text-white focus:outline-none focus:border-blue-600 transition-all placeholder-gray-600">
                </div>
            </div>
            <div class="overflow-y-auto flex-1 custom-scrollbar" id="asset-list"></div>
        </aside>

        <!-- CENTER -->
        <main class="flex-1 flex flex-col min-w-0 bg-gray-950/50 relative">
            <div class="lg:hidden p-2 border-b border-gray-800 bg-gray-900">
                <select id="mobile-asset-select" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-700 font-bold" onchange="window.selectAsset(this.value)"></select>
            </div>

            <!-- Asset Header -->
            <div class="h-16 border-b border-gray-800 flex items-center justify-between px-4 lg:px-6 bg-black/40 backdrop-blur-sm">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded bg-gradient-to-tr from-gray-800 to-gray-700 flex items-center justify-center border border-gray-600 text-white font-black text-lg shadow-lg" id="asset-icon">B</div>
                    <div>
                        <h2 class="text-lg lg:text-2xl font-black text-white leading-none tracking-tight flex items-center gap-2">
                            <span id="asset-name">Bitcoin</span> 
                            <span class="text-gray-600 text-sm lg:text-lg font-medium">/ <span id="current-currency">USD</span></span>
                        </h2>
                        <div class="flex items-center gap-3 mt-0.5">
                            <span class="text-[10px] text-blue-400 bg-blue-900/20 px-1.5 rounded border border-blue-900/50">VOLATILIT√â: HAUTE</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div id="asset-price" class="text-xl lg:text-3xl font-mono font-bold tracking-tighter text-white">...</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="flex-1 p-2 lg:p-4 relative bg-black/20 h-1/2 lg:h-auto min-h-[300px]">
                <div class="w-full h-full rounded-xl border border-gray-800 bg-black/60 overflow-hidden relative group shadow-2xl" id="chart-container"></div>
                <div class="absolute top-4 left-4 z-10 pointer-events-none">
                    <div class="flex items-center gap-2 bg-black/80 backdrop-blur px-3 py-1.5 rounded border border-gray-700 text-xs text-gray-300 shadow">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        LIVE SOCKET
                    </div>
                </div>
            </div>

            <!-- Trading Dock -->
            <div class="h-auto lg:h-80 border-t border-gray-800 bg-gray-900 flex flex-col lg:flex-row">
                <!-- Order Form -->
                <div class="w-full lg:w-96 p-4 lg:p-6 border-r border-gray-800 flex flex-col bg-gray-950 shadow-[inset_-10px_0_20px_-10px_rgba(0,0,0,0.5)]">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> Action Rapide</h3>
                        <div class="text-[10px] text-gray-500 border border-gray-700 px-1.5 py-0.5 rounded cursor-help">Ordre March√©</div>
                    </div>
                    <div class="space-y-3">
                        <div class="bg-gray-900 p-3 rounded border border-gray-800 focus-within:border-blue-500 transition-all group">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span class="group-focus-within:text-blue-400 transition-colors">Je d√©pense (<span class="currency-label">USD</span>)</span>
                                <span onclick="window.setMaxBuy()" class="text-gray-600 hover:text-white cursor-pointer transition-colors text-[10px] uppercase font-bold">MAX</span>
                            </div>
                            <input type="number" id="input-fiat" class="w-full bg-transparent text-white font-mono text-lg focus:outline-none placeholder-gray-800 font-bold" placeholder="0.00">
                        </div>
                        <div class="flex justify-center -my-4 z-10 relative">
                            <div class="bg-gray-800 rounded-full p-1.5 border border-gray-700 text-gray-400 shadow-xl">
                                <i data-lucide="arrow-right-left" class="w-3 h-3"></i>
                            </div>
                        </div>
                        <div class="bg-gray-900 p-3 rounded border border-gray-800 focus-within:border-blue-500 transition-all group">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span class="group-focus-within:text-blue-400 transition-colors">Volume (<span id="symbol-label">BTC</span>)</span>
                                <span onclick="window.setMaxSell()" class="text-gray-600 hover:text-white cursor-pointer transition-colors text-[10px] uppercase font-bold">VENDRE MAX</span>
                            </div>
                            <input type="number" id="input-qty" class="w-full bg-transparent text-white font-mono text-lg focus:outline-none placeholder-gray-800 font-bold" placeholder="0.000000">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4 pt-2">
                        <button onclick="window.executeTrade('BUY')" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 lg:py-4 rounded font-black text-sm transition-all active:scale-95 shadow-[0_4px_0_rgb(6,95,70)] active:shadow-none active:translate-y-[4px] uppercase tracking-widest">ACHETER</button>
                        <button onclick="window.executeTrade('SELL')" class="bg-rose-600 hover:bg-rose-500 text-white py-3 lg:py-4 rounded font-black text-sm transition-all active:scale-95 shadow-[0_4px_0_rgb(159,18,57)] active:shadow-none active:translate-y-[4px] uppercase tracking-widest">VENDRE</button>
                    </div>
                    <div id="notification-area" class="mt-3 h-8"></div>
                </div>

                <!-- Portfolio -->
                <div class="flex-1 flex flex-col bg-gray-900 min-h-[200px]">
                    <div class="flex items-center justify-between border-b border-gray-800 bg-gray-950 px-4 py-3">
                        <h3 class="text-xs font-bold uppercase tracking-wider text-blue-400">Vos Positions Actives</h3>
                        <div class="text-[10px] text-gray-500">P&L en temps r√©el</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="bg-gray-900 text-gray-500 text-[10px] uppercase sticky top-0 z-10 border-b border-gray-800">
                                <tr>
                                    <th class="px-4 py-3 font-medium">Actif</th>
                                    <th class="px-4 py-3 font-medium text-right">Qt√© / Prix Moy.</th>
                                    <th class="px-4 py-3 font-medium text-right">PnL (Gain/Perte)</th>
                                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800/30" id="portfolio-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="hidden lg:flex w-80 bg-gray-950 border-l border-gray-800 flex-col shrink-0">
            <div class="p-5 border-b border-gray-800 bg-gradient-to-b from-blue-900/20 to-transparent">
                <h3 class="text-blue-400 text-xs font-black uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="lightbulb" class="w-4 h-4"></i> Strat√©gie & Conseils</h3>
                <div class="bg-gray-900 border border-blue-900/30 p-4 rounded-xl relative overflow-hidden shadow-lg">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="rocket" class="w-12 h-12"></i></div>
                    <h4 class="text-white font-bold text-sm mb-2" id="tip-title">Chargement...</h4>
                    <p class="text-xs text-gray-400 leading-relaxed min-h-[60px]" id="tip-text">...</p>
                    <div class="flex justify-center gap-1 mt-3" id="tip-dots"></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center">
                    <h3 class="text-gray-400 text-xs font-black uppercase tracking-widest flex items-center gap-2"><i data-lucide="newspaper" class="w-4 h-4"></i> Market News</h3>
                    <span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30 animate-pulse">LIVE</span>
                </div>
                <div class="flex-1 overflow-y-auto p-0 custom-scrollbar relative" id="news-feed"></div>
            </div>
        </aside>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
    (function() {
        // --- DATA & CONFIG ---
        const BINANCE_MAP = {
            'BTC': 'btcusdt', 'ETH': 'ethusdt', 'SOL': 'solusdt', 'BNB': 'bnbusdt', 
            'XRP': 'xrpusdt', 'ADA': 'adausdt', 'DOGE': 'dogeusdt', 'DOT': 'dotusdt', 
            'AVAX': 'avaxusdt', 'LINK': 'linkusdt', 'MATIC': 'maticusdt', 'LTC': 'ltcusdt',
            'UNI': 'uniusdt', 'ATOM': 'atomusdt', 'ETC': 'etcusdt', 'FIL': 'filusdt',
            'NEAR': 'nearusdt', 'APT': 'aptusdt', 'ARB': 'arbusdt', 'OP': 'opusdt',
            'INJ': 'injusdt', 'RNDR': 'rndrusdt', 'PEPE': 'pepeusdt', 'SHIB': 'shibusdt',
            'TRX': 'trxusdt', 'XLM': 'xlmusdt', 'BCH': 'bchusdt', 'ALGO': 'algousdt',
            'VET': 'vetusdt', 'ICP': 'icpusdt', 'SAND': 'sandusdt', 'MANA': 'manausdt',
            'AXS': 'axsusdt', 'EGLD': 'egldusdt', 'THETA': 'thetausdt', 'FTM': 'ftmusdt',
            'SUI': 'suiusdt', 'SEI': 'seiusdt', 'TIA': 'tiausdt', 'STX': 'stxusdt',
            'IMX': 'imxusdt', 'RUNE': 'runeusdt', 'FET': 'fetusdt', 'AGIX': 'agixusdt',
            'FLOKI': 'flokiusdt', 'BONK': 'bonkusdt', 'WIF': 'wifusdt', 'JUP': 'jupusdt',
            'HBAR': 'hbarusdt', 'GRT': 'grtusdt', 'AAVE': 'aaveusdt', 'MKR': 'mkrusdt',
            'SNX': 'snxusdt', 'LDO': 'ldousdt', 'QNT': 'qntusdt', 'FLOW': 'flowusdt'
        };

        // --- STATE ---
        let state = {
            currency: 'USD',
            balance: 10000,
            portfolio: {}, 
            history: [],
            selectedAssetId: 'BTC',
            marketBias: 1.0,
            newsFeed: [],
            tipIndex: 0
        };

        let assets = Object.keys(BINANCE_MAP).map(key => ({
            id: key, name: key, symbol: key, basePrice: 100, currentPrice: 100, volatility: 0.05, change24h: 0,
            priceHistory: Array(50).fill(0).map((_, i) => ({ time: i, price: 100 }))
        }));

        let chartInstance = null;
        let ws = null;
        let biasTimeout = null;
        let currentSellAssetId = null; // Store asset ID for sell modal

        // --- CONSTANTS ---
        const SCENARIO_EVENTS = [
            { id: 'SEC_APPROVE', title: "ALERTE: SEC Approuve ETF", desc: "Les institutions entrent en masse.", advice: "ACHAT FORT probable.", impact: 1.05, duration: 20000, type: 'success' },
            { id: 'HACK', title: "URGENT: Hack Exchange", desc: "Panique sur les march√©s.", advice: "VENTE CONSEILL√âE.", impact: 0.92, duration: 15000, type: 'error' },
            { id: 'ELON', title: "Elon Musk Tweet", desc: "Les Memecoins s'envolent.", advice: "Volatilit√© extr√™me.", impact: 1.08, duration: 10000, type: 'success' },
            { id: 'RATES', title: "Taux FED en hausse", desc: "L'argent devient cher.", advice: "PRUDENCE.", impact: 0.97, duration: 25000, type: 'error' },
            { id: 'ADOPTION', title: "Pays adopte BTC", desc: "Signal haussier long terme.", advice: "Accumulation recommand√©e.", impact: 1.04, duration: 20000, type: 'success' },
            { id: 'STABLE_DEPEG', title: "ALERTE: Depeg Stablecoin", desc: "USDC perd son ancrage.", advice: "Fuyez vers le BTC.", impact: 0.95, duration: 15000, type: 'error' }
        ];

        const FILLER_NEWS = [
            "SEC reporte d√©cision ETF.", "UE finalise loi MiCA.", "Hong Kong ouvre crypto.", "FMI avertit pays √©mergents.",
            "Vitalik d√©voile roadmap.", "Solana congestion mineure.", "Frais Bitcoin au plus bas.", "Aave √©vite bug critique.",
            "Fear & Greed: Extreme Greed.", "Volumes DEX +20%.", "Goldman Sachs optimiste.", "R√©serves √©changes au plus bas.",
            "BlackRock lance fonds tokenis√©.", "Visa teste paiements gas.", "Google Cloud validateur Tezos.", "CryptoPunk vendu 3M$.",
            "MakerDAO augmente taux.", "Mineur solo gagne 6.25 BTC.", "Elon Musk m√®me myst√©rieux.", "JPMorgan s'int√©resse √† la DeFi.",
            "Le hashrate du Bitcoin explose.", "Tether imprime 1Mds USDT.", "Coinbase lance wallet intelligent.", "Ripple signe un partenariat bancaire.",
            "Le volume des NFT remonte.", "Avalanche lance un sous-r√©seau.", "Polkadot pr√©pare sa mise √† jour 2.0.", "Les baleines accumulent du SHIB."
        ];

        const TRADING_TIPS = [
            { title: "DCA", text: "Investissez une somme fixe r√©guli√®rement pour lisser le prix d'entr√©e." },
            { title: "Stop-Loss", text: "D√©finissez votre perte max avant d'entrer. Coupez si atteint." },
            { title: "Rotation", text: "Bitcoin -> Ethereum -> Altcoins -> P√©pites -> Crash." },
            { title: "FOMO", text: "Si +30% en 1h, c'est trop tard. N'achetez pas la bougie verte." },
            { title: "DYOR", text: "Ne suivez pas les influenceurs aveugl√©ment. V√©rifiez le projet." },
            { title: "R√®gle 1%", text: "Ne risquez jamais plus de 1% du capital sur un trade." },
            { title: "Not Your Keys", text: "Pas de cl√© priv√©e = pas vos cryptos (sauf ici !)." },
            { title: "Psychologie", text: "Le trading est 90% √©motionnel. Restez froid." }
        ];

        // --- GLOBAL EXPORTS ---
        window.closeWelcome = function() { document.getElementById('welcome-modal').classList.add('hidden'); }
        window.closeFlash = function() { document.getElementById('flash-modal').classList.add('hidden'); }
        window.closeSellModal = function() { document.getElementById('sell-modal').classList.add('hidden'); }
        
        window.setCurrency = function(c) {
            state.currency = c;
            updateUI();
            const btnUsd = document.getElementById('btn-usd');
            const btnEur = document.getElementById('btn-eur');
            if (c === 'USD') {
                btnUsd.className = "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow";
                btnEur.className = "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300";
            } else {
                btnEur.className = "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all bg-gray-700 text-white shadow";
                btnUsd.className = "px-2 lg:px-3 py-1 text-xs font-bold rounded transition-all text-gray-500 hover:text-gray-300";
            }
        };

        window.selectAsset = function(id, mode = 'BUY') {
            state.selectedAssetId = id;
            renderAssetsList(); // Update highlight
            updateChart();
            document.getElementById('input-fiat').value = '';
            document.getElementById('input-qty').value = '';
            const mobileSelect = document.getElementById('mobile-asset-select');
            if(mobileSelect) mobileSelect.value = id;
            if (mode === 'SELL') window.setMaxSell();
        };

        window.setMaxBuy = function() {
            handleFiatChange(state.balance.toString());
            document.getElementById('input-fiat').value = state.balance.toFixed(2);
        };

        window.setMaxSell = function() {
            const entry = state.portfolio[state.selectedAssetId];
            const owned = entry ? entry.qty : 0;
            handleQtyChange(owned.toString());
            document.getElementById('input-qty').value = owned;
        };

        // --- MODAL SELL FUNCTIONS ---
        window.initiateSell = function(assetId) {
            const entry = state.portfolio[assetId];
            const asset = assets.find(a => a.id === assetId);
            if (!entry || !asset) return;

            currentSellAssetId = assetId;
            const price = getLastPrice(asset);

            document.getElementById('sell-modal-asset').innerText = asset.symbol;
            document.getElementById('sell-modal-max-qty').innerText = entry.qty.toFixed(6);
            document.getElementById('sell-modal-price').innerText = formatMoney(price, true);
            
            // Reset input
            const input = document.getElementById('sell-modal-input-qty');
            input.value = '';
            document.getElementById('sell-modal-total').innerText = formatMoney(0);

            // Bind input change
            input.oninput = function() {
                const val = parseFloat(this.value) || 0;
                const currentPrice = getLastPrice(asset); // Re-fetch for freshness
                document.getElementById('sell-modal-total').innerText = formatMoney(val * currentPrice);
            };

            // Bind confirm button
            const confirmBtn = document.getElementById('confirm-sell-btn');
            confirmBtn.onclick = function() {
                window.executeSellFromModal();
            };

            // Show modal
            document.getElementById('sell-modal').classList.remove('hidden');
        };

        window.setMaxSellModal = function() {
            const entry = state.portfolio[currentSellAssetId];
            if(entry) {
                const input = document.getElementById('sell-modal-input-qty');
                input.value = entry.qty;
                input.dispatchEvent(new Event('input')); // Trigger update
            }
        };

        window.executeSellFromModal = function() {
            const qty = parseFloat(document.getElementById('sell-modal-input-qty').value);
            const entry = state.portfolio[currentSellAssetId];
            const asset = assets.find(a => a.id === currentSellAssetId);

            if (!entry || !asset) return window.closeSellModal();
            if (!qty || qty <= 0 || qty > entry.qty) {
                // Flash input red if invalid
                const input = document.getElementById('sell-modal-input-qty');
                input.classList.add('border-rose-500');
                setTimeout(() => input.classList.remove('border-rose-500'), 500);
                return;
            }

            const price = getLastPrice(asset);
            const total = qty * price;

            // Credit Balance
            state.balance += total;
            
            // Remove from portfolio
            const newQty = Math.max(0, entry.qty - qty);
            if (newQty === 0) delete state.portfolio[currentSellAssetId];
            else state.portfolio[currentSellAssetId] = { qty: newQty, avgPrice: entry.avgPrice };

            // Log
            state.history.unshift({ date: new Date(), type: 'SELL', asset: asset.symbol, qty: qty, price, total });
            
            // UI Updates
            renderPortfolio();
            updateHeaderData();
            window.closeSellModal();
            notify(`Vente de ${qty} ${asset.symbol} r√©ussie (+${formatMoney(total)})`, 'success');
        };

        window.executeTrade = function(type) {
            const asset = getSelectedAsset();
            const price = getLastPrice(asset);
            const qtyInput = document.getElementById('input-qty');
            const qty = parseFloat(qtyInput.value);

            if (!qty || qty <= 0) return notify("Montant invalide", 'error');

            const total = qty * price;
            const currentEntry = state.portfolio[asset.id] || { qty: 0, avgPrice: 0 };

            if (type === 'BUY') {
                if (total > state.balance) return notify("Fonds insuffisants", 'error');
                state.balance -= total;
                const newQty = currentEntry.qty + qty;
                const newAvg = ((currentEntry.qty * currentEntry.avgPrice) + total) / newQty;
                state.portfolio[asset.id] = { qty: newQty, avgPrice: newAvg };
                notify(`Achat ${qty.toFixed(6)} ${asset.symbol} r√©ussi`, 'success');
            } else {
                const owned = currentEntry.qty;
                if (qty > owned + 0.0000001) return notify("Solde insuffisant", 'error');
                state.balance += total;
                const newQty = Math.max(0, owned - qty);
                if (newQty === 0) delete state.portfolio[asset.id];
                else state.portfolio[asset.id] = { qty: newQty, avgPrice: currentEntry.avgPrice };
                notify(`Vente ${qty.toFixed(6)} ${asset.symbol} r√©ussie`, 'success');
            }

            state.history.unshift({ date: new Date(), type, asset: asset.symbol, qty, price, total });
            renderPortfolio();
            updateHeaderData();
            qtyInput.value = '';
            document.getElementById('input-fiat').value = '';
        };

        window.refillBalance = function() {
            state.balance += 10000;
            updateHeaderData();
            notify("Compte renflou√© ! +10 000$", 'success');
        };

        // --- UTILS ---
        function getSelectedAsset() { return assets.find(a => a.id === state.selectedAssetId) || assets[0]; }
        function getLastPrice(asset) { return asset.currentPrice * state.marketBias; }
        
        function formatMoney(amount, isPrice = false) {
            const rate = state.currency === 'EUR' ? 0.92 : 1;
            const symbol = state.currency === 'EUR' ? '‚Ç¨' : '$';
            const val = amount * rate;
            let decimals = 2;
            if (isPrice) {
                if (val < 1000) decimals = 2;
                if (val < 1) decimals = 4;
                if (val < 0.01) decimals = 6;
                if (val < 0.0001) decimals = 8;
            }
            return `${symbol}${val.toLocaleString('fr-FR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals })}`;
        }

        function notify(msg, type) {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-emerald-900/50 text-emerald-200 border-emerald-800' : 'bg-rose-900/50 text-rose-200 border-rose-800';
            area.innerHTML = `<div class="text-xs font-bold text-center py-2 rounded border ${color} animate-fade-in">${msg}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }

        function handleFiatChange(val) {
            const asset = getSelectedAsset();
            const price = getLastPrice(asset);
            const qtyInput = document.getElementById('input-qty');
            if (!val) { qtyInput.value = ''; return; }
            qtyInput.value = (parseFloat(val) / price).toFixed(6);
        }

        function handleQtyChange(val) {
            const asset = getSelectedAsset();
            const price = getLastPrice(asset);
            const fiatInput = document.getElementById('input-fiat');
            if (!val) { fiatInput.value = ''; return; }
            fiatInput.value = (parseFloat(val) * price).toFixed(2);
        }

        // --- CORE FUNCTIONS ---
        function init() {
            if(typeof lucide === 'undefined') console.warn("Lucide not loaded");
            if(typeof ApexCharts === 'undefined') console.warn("ApexCharts not loaded");

            const saved = localStorage.getItem('tradeLearnPro_gh');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.portfolio && typeof Object.values(parsed.portfolio)[0] === 'number') {
                         const migrated = {};
                         Object.entries(parsed.portfolio).forEach(([k, q]) => {
                             migrated[k] = { qty: q, avgPrice: assets.find(a=>a.id===k)?.currentPrice || 0 };
                         });
                         parsed.portfolio = migrated;
                    }
                    state = { ...state, ...parsed };
                } catch(e) {}
            }

            if(typeof lucide !== 'undefined') lucide.createIcons();
            initChart();
            renderAssetsList();
            renderMobileSelect();
            updateUI();
            connectWS();
            startLoops();
            
            if (state.newsFeed.length === 0) {
                state.newsFeed = FILLER_NEWS.slice(0, 5).map((t, i) => ({ title: t, type: 'info', time: `${i*5+2} min` }));
            }
            renderInitialNews();
            renderTip();

            document.getElementById('input-fiat').addEventListener('input', (e) => handleFiatChange(e.target.value));
            document.getElementById('input-qty').addEventListener('input', (e) => handleQtyChange(e.target.value));
            document.getElementById('search-input').addEventListener('input', (e) => filterAssets(e.target.value));
        }

        function connectWS() {
            const streams = Object.values(BINANCE_MAP).map(s => `${s}@trade`).join('/');
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
            ws.onopen = () => {
                document.getElementById('connection-status').innerHTML = `<span class="flex items-center gap-1 text-emerald-400 animate-pulse"><i data-lucide="wifi" class="w-3 h-3"></i> Live Feed</span>`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            };
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.data && msg.data.s) {
                    const symbol = msg.data.s;
                    const price = parseFloat(msg.data.p);
                    const asset = assets.find(a => BINANCE_MAP[a.id].toUpperCase() === symbol);
                    if (asset) {
                        asset.currentPrice = price; 
                        if(asset.basePrice === 100) asset.basePrice = price; 
                    }
                }
            };
            ws.onerror = () => {
                document.getElementById('connection-status').innerHTML = `<span class="flex items-center gap-1 text-rose-500"><i data-lucide="wifi-off" class="w-3 h-3"></i> Disconnected</span>`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            };
        }

        function startLoops() {
            setInterval(() => {
                assets.forEach(a => {
                    const biasedPrice = a.currentPrice * state.marketBias;
                    const newPoint = { time: Date.now(), price: biasedPrice };
                    a.priceHistory.push(newPoint);
                    if(a.priceHistory.length > 50) a.priceHistory.shift();
                    const start = a.priceHistory[0].price;
                    a.change24h = ((biasedPrice - start) / start) * 100;
                });
                updateChart();
                updateHeaderData();
                updateAssetListUI();
                renderPortfolio();
                localStorage.setItem('tradeLearnPro_gh', JSON.stringify({ balance: state.balance, portfolio: state.portfolio, history: state.history }));
            }, 1000);

            setInterval(() => { addFillerNews(); }, 15000); 
            setInterval(() => { if (Math.random() < 0.025) triggerEvent(); }, 60000);
            setInterval(() => {
                state.tipIndex = (state.tipIndex + 1) % TRADING_TIPS.length;
                renderTip();
            }, 20000);
        }

        function initChart() {
            if(typeof ApexCharts === 'undefined') return;
            const options = {
                chart: { type: 'area', height: '100%', fontFamily: 'JetBrains Mono, monospace', animations: { enabled: false }, toolbar: { show: false }, background: 'transparent' },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 3 },
                dataLabels: { enabled: false },
                grid: { show: true, borderColor: '#333', strokeDashArray: 3, xaxis: { lines: { show: false } } },
                xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { opposite: true, labels: { formatter: (val) => val.toFixed(2), style: { colors: '#9ca3af' } } },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] } },
                colors: ['#10b981'],
                series: [{ name: 'Prix', data: [] }],
                tooltip: { theme: 'dark', x: { show: false } }
            };
            chartInstance = new ApexCharts(document.querySelector("#chart-container"), options);
            chartInstance.render();
        }

        function updateChart() {
            if(!chartInstance) return;
            const asset = getSelectedAsset();
            const data = asset.priceHistory.map(p => p.price);
            const isUp = asset.change24h >= 0;
            const color = isUp ? '#10b981' : '#f43f5e';
            const container = document.querySelector("#chart-container");
            if (isUp) container.classList.remove('chart-down'); else container.classList.add('chart-down');
            chartInstance.updateOptions({ colors: [color], yaxis: { labels: { formatter: (val) => formatMoney(val, true).replace('$', '').replace('‚Ç¨', '') } } });
            chartInstance.updateSeries([{ data: data }]);

            const price = getLastPrice(asset);
            document.getElementById('asset-name').innerText = asset.name;
            document.getElementById('asset-icon').innerText = asset.symbol[0];
            document.getElementById('current-currency').innerText = state.currency;
            document.getElementById('symbol-label').innerText = asset.symbol;
            
            const priceEl = document.getElementById('asset-price');
            priceEl.innerText = formatMoney(price, true);
            priceEl.className = `text-xl lg:text-3xl font-mono font-bold tracking-tighter ${isUp ? 'text-emerald-400' : 'text-rose-500'}`;
        }

        function renderAssetsList() {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';
            assets.forEach(asset => {
                const div = document.createElement('div');
                div.className = `group px-4 py-3 border-b border-gray-800/50 cursor-pointer transition-all hover:bg-gray-900 relative overflow-hidden asset-item`;
                div.dataset.id = asset.id;
                div.onclick = () => window.selectAsset(asset.id, 'BUY');
                
                const isSelected = asset.id === state.selectedAssetId;
                const indicatorClass = isSelected ? '' : 'hidden';
                const bgClass = isSelected ? 'bg-blue-900/10' : '';
                div.className += ` ${bgClass}`;

                div.innerHTML = `
                    <div class="selection-indicator absolute left-0 top-0 bottom-0 w-1 bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.8)] ${indicatorClass}"></div>
                    <div class="flex justify-between items-center mb-1 relative z-10">
                        <span class="font-bold text-sm text-gray-300 group-hover:text-white">${asset.symbol}</span>
                        <span class="font-mono text-sm text-gray-200 price-display">...</span>
                    </div>
                    <div class="flex justify-between items-center relative z-10">
                        <span class="text-[10px] text-gray-500 uppercase font-medium truncate max-w-[100px]">${asset.name}</span>
                        <span class="flex items-center gap-1 text-[10px] font-bold change-display">...</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAssetListUI() {
            const items = document.querySelectorAll('.asset-item');
            items.forEach(item => {
                const id = item.dataset.id;
                const asset = assets.find(a => a.id === id);
                if (asset) {
                    const price = getLastPrice(asset);
                    item.querySelector('.price-display').innerText = formatMoney(price, true);
                    const changeEl = item.querySelector('.change-display');
                    changeEl.innerText = `${asset.change24h >= 0 ? '+' : ''}${asset.change24h.toFixed(2)}%`;
                    changeEl.className = `flex items-center gap-1 text-[10px] font-bold change-display ${asset.change24h >= 0 ? 'text-emerald-400' : 'text-rose-500'}`;
                }
            });
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolio-body');
            tbody.innerHTML = '';
            const entries = Object.entries(state.portfolio);
            if (entries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-gray-600"><i data-lucide="wallet" class="mx-auto mb-2 opacity-50"></i><span class="text-xs uppercase tracking-widest">Portefeuille Vide</span></td></tr>`;
            } else {
                entries.forEach(([id, data]) => {
                    const asset = assets.find(a => a.id === id);
                    if (!asset) return;
                    
                    const price = getLastPrice(asset);
                    const currentValue = data.qty * price;
                    const costBasis = data.qty * data.avgPrice;
                    const pnl = currentValue - costBasis;
                    const pnlPercent = costBasis > 0 ? (pnl / costBasis) * 100 : 0;
                    const isProfit = pnl >= 0;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-800/30 transition-colors border-b border-gray-800/30";
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 align-middle">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center font-bold text-xs border border-gray-700 text-gray-300 shadow-sm">${asset.symbol[0]}</div>
                                <div>
                                    <div class="font-bold text-white text-sm">${asset.symbol}</div>
                                    <div class="text-[10px] text-gray-500 font-mono">${formatMoney(price, true)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right align-middle">
                            <div class="font-mono text-gray-200 text-sm font-medium">${data.qty.toFixed(4)}</div>
                            <div class="text-[10px] text-gray-500">Moy: ${formatMoney(data.avgPrice, true)}</div>
                        </td>
                        <td class="px-4 py-3 text-right align-middle">
                            <div class="font-mono text-sm font-bold ${isProfit ? 'text-emerald-400' : 'text-rose-500'}">
                                ${isProfit ? '+' : ''}${formatMoney(pnl)}
                            </div>
                            <div class="text-[10px] ${isProfit ? 'text-emerald-500/70' : 'text-rose-500/70'}">
                                ${isProfit ? '+' : ''}${pnlPercent.toFixed(2)}%
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right align-middle">
                            <button onclick="window.initiateSell('${id}')" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-white text-xs font-bold transition-colors shadow-sm uppercase tracking-wider">
                                VENDRE
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function createNewsItemDOM(news, animate = true) {
            const div = document.createElement('div');
            div.className = `p-4 border-b border-gray-800 hover:bg-gray-900/50 transition-colors cursor-default group ${animate ? 'animate-news-item' : ''}`;
            let typeColor = news.type === 'success' ? 'bg-emerald-900/30 text-emerald-400' : 
                            news.type === 'error' ? 'bg-rose-900/30 text-rose-400' : 
                            news.type === 'alert' ? 'bg-yellow-900/30 text-yellow-400' : 'bg-blue-900/30 text-blue-400';
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${typeColor}">${news.type}</span>
                    <span class="text-[10px] text-gray-600">${news.time}</span>
                </div>
                <p class="text-xs text-gray-300 font-medium leading-snug group-hover:text-white transition-colors">${news.title}</p>
            `;
            return div;
        }

        function addNewsToFeed(newsItem) {
            const container = document.getElementById('news-feed');
            state.newsFeed.unshift(newsItem);
            if (state.newsFeed.length > 20) state.newsFeed.pop();
            const div = createNewsItemDOM(newsItem, true);
            container.insertBefore(div, container.firstChild);
            if (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        function renderInitialNews() {
            const container = document.getElementById('news-feed');
            container.innerHTML = '';
            state.newsFeed.forEach(news => {
                container.appendChild(createNewsItemDOM(news, false));
            });
        }

        function addFillerNews() {
            const newsTitle = FILLER_NEWS[Math.floor(Math.random() * FILLER_NEWS.length)];
            if (state.newsFeed.length > 0 && state.newsFeed[0].title === newsTitle) return;
            addNewsToFeed({ title: newsTitle, type: 'info', time: "√Ä L'INSTANT" });
        }

        function triggerEvent() {
            const scenario = SCENARIO_EVENTS[Math.floor(Math.random() * SCENARIO_EVENTS.length)];
            const modal = document.getElementById('flash-modal');
            const content = document.getElementById('flash-content');
            let icon = scenario.type === 'error' ? 'alert-triangle' : scenario.type === 'success' ? 'rocket' : 'siren';
            let colorClass = scenario.type === 'error' ? 'text-rose-300' : scenario.type === 'success' ? 'text-emerald-300' : 'text-blue-300';
            
            content.innerHTML = `
                <div class="absolute inset-0 opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                <div class="relative z-10 text-center">
                    <div class="mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-xl border-4 bg-gray-800 border-gray-600">
                        <i data-lucide="${icon}" class="w-10 h-10 text-white animate-pulse"></i>
                    </div>
                    <h2 class="text-3xl font-black text-white mb-2 uppercase tracking-tight drop-shadow-md">FLASH MARCH√â</h2>
                    <h3 class="text-xl font-bold mb-6 ${colorClass}">${scenario.title}</h3>
                    <div class="bg-black/40 rounded-xl p-4 mb-6 border border-white/10 text-left">
                        <p class="text-gray-200 text-sm mb-3 font-medium">${scenario.desc}</p>
                        <div class="flex items-start gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-yellow-400 shrink-0 mt-0.5"></i>
                            <p class="text-yellow-400 text-xs font-bold italic">CONSEIL: ${scenario.advice}</p>
                        </div>
                    </div>
                    <button onclick="window.closeFlash()" class="w-full bg-white text-black font-black py-4 rounded-lg hover:scale-[1.02] transition-transform shadow-xl uppercase tracking-widest text-sm">COMPRIS !</button>
                </div>
            `;
            if(typeof lucide !== 'undefined') lucide.createIcons();
            modal.classList.remove('hidden');
            addNewsToFeed({ title: scenario.title, type: scenario.type, time: "√Ä L'INSTANT" });

            const target = scenario.impact;
            let step = 0;
            const interval = setInterval(() => {
                state.marketBias += (target - state.marketBias) * 0.1;
                step++;
                if (step > 20) clearInterval(interval);
            }, 100);

            if (biasTimeout) clearTimeout(biasTimeout);
            biasTimeout = setTimeout(() => {
                const reset = setInterval(() => {
                    state.marketBias += (1.0 - state.marketBias) * 0.05;
                    if (Math.abs(state.marketBias - 1.0) < 0.001) {
                        state.marketBias = 1.0;
                        clearInterval(reset);
                    }
                }, 200);
            }, scenario.duration);
        }

        function renderTip() {
            const tip = TRADING_TIPS[state.tipIndex];
            document.getElementById('tip-title').innerText = tip.title;
            document.getElementById('tip-text').innerText = tip.text;
            const dots = document.getElementById('tip-dots');
            dots.innerHTML = '';
            TRADING_TIPS.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = `h-1 rounded-full transition-all duration-300 ${i === state.tipIndex ? 'w-6 bg-blue-500' : 'w-2 bg-gray-700'}`;
                dots.appendChild(d);
            });
        }

        function filterAssets(term) {
            const t = term.toLowerCase();
            document.querySelectorAll('.asset-item').forEach(el => {
                const id = el.dataset.id;
                const asset = assets.find(a => a.id === id);
                if (asset && (asset.name.toLowerCase().includes(t) || asset.symbol.toLowerCase().includes(t))) {
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            });
        }

        function renderMobileSelect() {
            const select = document.getElementById('mobile-asset-select');
            select.innerHTML = '';
            assets.forEach(asset => {
                const opt = document.createElement('option');
                opt.value = asset.id;
                opt.text = asset.name + ` (${asset.symbol})`;
                select.appendChild(opt);
            });
            select.value = state.selectedAssetId;
        }

        function updateUI() {
            document.querySelectorAll('.currency-label').forEach(el => el.innerText = state.currency);
            updateHeaderData();
            updateChart();
            renderPortfolio();
        }

        function updateHeaderData() {
            document.getElementById('balance-display').innerText = formatMoney(state.balance);
            let portfolioVal = 0;
            Object.entries(state.portfolio).forEach(([id, data]) => {
                const asset = assets.find(a => a.id === id);
                if (asset) portfolioVal += data.qty * getLastPrice(asset);
            });
            const netWorth = state.balance + portfolioVal;
            const pnl = netWorth - 10000;
            const nwEl = document.getElementById('networth-display');
            nwEl.innerText = formatMoney(netWorth);
            nwEl.className = `flex items-center gap-2 font-mono font-bold text-lg ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-500'}`;
            const refillBtn = document.getElementById('refill-btn');
            if (state.balance < 50) refillBtn.classList.remove('hidden'); else refillBtn.classList.add('hidden');
        }

        // Start
        window.onload = init;
    })();
    </script>
</body>
</html>
